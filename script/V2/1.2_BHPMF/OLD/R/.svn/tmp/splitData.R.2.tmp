splitData <- function(permutMatTest, permutMatV, noTraits, X, zsLogX, traitsName, name, treeFile, secondCV, testFlag){


    if (testFlag){
        #generate all test, and validation
        numTrials = ncol(permutMatTest);

        ii3 = which(noTraits >= 3);
        
        jj3Test = matrix(permutMatTest[ii3, ], ncol = ncol(permutMatTest));
        jjValid = matrix(permutMatV[ii3, ], ncol = ncol(permutMatV));
        
        iiValid = matrix(rep(ii3, numTrials), nrow = length(ii3), ncol = numTrials);
        
        #       iiValid = repmat(ii3', 1, numTrials);

        if(nchar(treeFile) != 0){
            load(treeFile)
        }

        ii2 = which(noTraits == 2);
        
        #iiTest = [repmat(ii3', 1, numTrials); repmat(ii2', 1, numTrials)];
        iiTest = matrix(rep(ii2, numTrials), nrow = length(ii2), ncol = numTrials);
        iiTest = rbind(iiValid, iiTest);
    
        #jjTest = [ jj3Test; permutMatTest(ii2, :)];
        jjTest = matrix(permutMatTest[ii2, ], ncol = ncol(permutMatTest));
        jjTest = rbind(jj3Test, jjTest);
    }
    else{

        #generate only validation

        numTrials = ncol(permutMatV);

        ii2 = which(noTraits >= 2);
        jjValid = matrix(permutMatV[ii2, ], ncol = ncol(permutMatV));
        
        iiValid = matrix(rep(ii2, numTrials), nrow = length(ii2), ncol = numTrials);
        
        #        iiValid = repmat(ii2', 1, numTrials);

        if(nchar(treeFile) != 0){
            load(treeFile)
        }

        iiTest = matrix(0,0,0);
        jjTest = matrix(0,0,0);
    }

    if(secondCV){
        allzsLogYtrain = vector('list', numTrials);
        allzsLogYtes = vector('list', numTrials);
        allzsLogYv = vector('list', numTrials);
    }
    
    print(numTrials)

    numElem = nrow(X) * ncol(X);
    subIdx = matrix(1:numElem, nrow(X), ncol(X));
    
    testLen = nrow(iiTest);
    valLen = nrow(iiValid);
    trainLen = numElem - testLen - valLen;
    print(testLen)
    
    indTest =  matrix(numeric(0), testLen, numTrials);
    indValid = matrix(numeric(0), valLen, numTrials);
    indTrain = matrix(numeric(0), trainLen, numTrials);
    

    for (trial in 1 : numTrials){

        zsLogXtrain = matrix(0, nrow(X), ncol(X));
        zsLogXtest = matrix(0, nrow(X), ncol(X));
        zsLogXv = matrix(0, nrow(X), ncol(X));

        indValid[, trial] = subIdx[cbind(iiValid[, trial], jjValid[, trial])];

        if (testFlag){
            indTest[, trial] = subIdx[cbind(iiTest[, trial], jjTest[, trial])];
            zsLogXtest[indTest[, trial]] = zsLogX[indTest[, trial]];
            Idx <- which(zsLogXtest != 0, arr.ind=TRUE);
            zsLogYtest = cbind(Idx, zsLogXtest[Idx]);
            rm(Idx);
            #[zsLogYtest(:,1), zsLogYtest(:,2), zsLogYtest(:,3)] = find(zsLogXtest);
            

            indTrain[, trial] = setdiff(1:numElem, rbind(indTest[, trial], indValid[, trial]));
            zsLogXtrain[indTrain[, trial]] = zsLogX[indTrain[, trial]];
            Idx <- which(zsLogXtrain != 0, arr.ind=TRUE);
            zsLogYtrain = cbind(Idx, zsLogXtrain[Idx]);
            rm(Idx);
            #[zsLogYtrain(:,1), zsLogYtrain(:,2), zsLogYtrain(:,3)] = find(zsLogXtrain);
            
        }
        else{
            
            indTrain[, trial] = setdiff(1:numElem, indValid[, trial]);
            zsLogXtrain[indTrain[, trial]] = zsLogX[indTrain[, trial]];
            Idx <- which(zsLogXtrain != 0, arr.ind=TRUE);
            zsLogYtrain = cbind(Idx, zsLogXtrain[Idx]);
            rm(Idx);
            
            zsLogYtest = matrix(numeric(0), 0, 0);
            
        }

        zsLogXv[indValid[, trial]] = zsLogX[indValid[, trial]];
        Idx <- which(zsLogXv != 0, arr.ind=TRUE);
        zsLogYv = cbind(Idx, zsLogXv[Idx]);
        rm(Idx);
        
        if (secondCV){
            allzsLogYtrain[[trial]] = zsLogYtrain;
            allzsLogYtes[[trial]] = zsLogYtest;
            allzsLogYv[[trial]] = zsLogYv;
        }
        else{
            fileName <- paste(name, trial, ".Rda", sep="");
            if(nchar(treeFile) != 0){
                save(file = fileName, list = c('X', 'Y', 'logm', 'logs', 'traitNames', 'treeIds', 'zsLogX', 'zsLogY', 'zsLogYtrain', 'zsLogYtest', 'zsLogYv'))
            }
            else{
                if (!testFlag)
                    fileName = name;
                save(file = name, list = c('zsLogYtrain', 'zsLogYtest', 'zsLogYv', 'traitsName'))
            }
        }

    }

    if (secondCV){
        vars = c('allzsLogYtrain', 'allzsLogYtest', 'allzsLogYv');
        lapply(vars, append.Rda, file = name);
    }

    return(list(indValid, indTest, indTrain));
    
}
